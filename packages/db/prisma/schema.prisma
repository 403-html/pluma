// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id              String            @id @default(uuid())
  email           String            @unique
  passwordHash    String
  createdAt       DateTime          @default(now())
  sessions        Session[]
  passwordHistory PasswordHistory[]
}

model Session {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
}

model PasswordHistory {
  id           String   @id @default(uuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  passwordHash String
  createdAt    DateTime @default(now())

  @@index([userId])
}

model Project {
  id           String        @id @default(uuid())
  key          String        @unique
  name         String
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  sdkTokens    SdkToken[]
  featureFlags FeatureFlag[]
  environments Environment[]
}

model Environment {
  id            String       @id @default(uuid())
  projectId     String
  project       Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  key           String
  name          String
  configVersion Int          @default(0)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  flagConfigs   FlagConfig[]
  sdkTokens     SdkToken[]

  @@unique([projectId, key])
}

model SdkToken {
  id          String       @id @default(uuid())
  projectId   String
  project     Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  envId       String?
  environment Environment? @relation(fields: [envId], references: [id], onDelete: Cascade)
  name        String
  tokenHash   String       @unique
  createdAt   DateTime     @default(now())
  revokedAt   DateTime?
}

model FeatureFlag {
  id           String        @id @default(uuid())
  projectId    String
  project      Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  key          String
  name         String
  description  String?
  parentFlagId String?
  parentFlag   FeatureFlag?  @relation("SubFlags", fields: [parentFlagId], references: [id], onDelete: Cascade)
  subFlags     FeatureFlag[] @relation("SubFlags")
  createdAt    DateTime      @default(now())
  flagConfigs  FlagConfig[]

  @@unique([projectId, key])
}

model FlagConfig {
  envId       String
  environment Environment @relation(fields: [envId], references: [id], onDelete: Cascade)
  flagId      String
  flag        FeatureFlag @relation(fields: [flagId], references: [id], onDelete: Cascade)
  enabled     Boolean     @default(false)
  allowList   String[]
  denyList    String[]

  @@id([envId, flagId])
}

model AuditLog {
  id         String   @id @default(uuid())
  action     String   // "create" | "update" | "delete" | "enable" | "disable"
  entityType String   // "project" | "flag" | "environment" | "flagConfig" | "token"
  entityId   String
  entityKey  String?
  projectId  String?
  projectKey String?
  envId      String?
  envKey     String?
  flagId     String?
  flagKey    String?
  actorId    String
  actorEmail String
  details    Json?
  createdAt  DateTime @default(now())

  @@index([projectId])
  @@index([flagId])
  @@index([envId])
  @@index([createdAt])
}
